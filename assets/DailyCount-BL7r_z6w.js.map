{"version":3,"file":"DailyCount-BL7r_z6w.js","sources":["../../src/hooks/use-statistics.ts","../../src/views/admin/DailyCount.vue"],"sourcesContent":["import { computed, onMounted, Ref, ref, watch } from 'vue'\nimport dayjs from 'dayjs'\nimport { get } from 'lodash-es'\nimport { useCrudAjax } from './use-crud-ajax'\n\n/**\n *\n *\n * @author CaoMeiYouRen\n * @date 2024-06-28\n * @export\n * @param model\n * @param category 横轴数据\n * @param columns 纵轴数据\n */\nexport function useStatistics(model: string, category: string, columns: string[]) {\n    const form = ref()\n    const { loading, list, getOption, page, getList, option } = useCrudAjax(form, model, undefined, false)\n\n    page.value.pageSize = 1000 // 设置记录条数\n\n    const defaultDate = dayjs().hour(0).minute(0).second(0).millisecond(0)\n    const defaultStart = defaultDate.add(-31, 'day')\n    const defaultEnd = defaultDate.add(1, 'day').add(-1, 'millisecond')\n\n    const datetimerange: Ref<Date[]> = ref([\n        defaultStart.toDate(),\n        defaultEnd.toDate(),\n    ])\n\n    const column = computed(() => option.value.column?.filter((e) => columns.includes(e?.prop || '')) || [])\n\n    const chartOption = computed(() => ({\n        xAxis: {\n            type: 'category',\n            data: list.value.map((e) => get(e, category)),\n        },\n        yAxis: {\n            type: 'value',\n        },\n        series: column.value.map((col) => ({\n            data: list.value.map((e) => get(e, col?.prop || '')),\n            type: 'line',\n            name: col.label,\n        })),\n        tooltip: {\n            trigger: 'axis',\n        },\n        legend: {\n            data: column.value.map((e) => e.label),\n            orient: 'vertical',\n            right: 10,\n            top: 'center',\n        },\n    }))\n\n    const onSearch = async () => {\n        const start = datetimerange.value[0]\n        const end = datetimerange.value[1]\n        loading.value = true\n        await getList(\n            {\n                date: {\n                    $op: 'Between',\n                    value: [start, end],\n                },\n            },\n            {\n                // date: 'ASC', // 正序\n                rawDate: 'ASC', // 正序\n                createdAt: undefined,\n                id: undefined,\n            },\n        )\n        loading.value = false\n    }\n\n    watch([datetimerange], async () => {\n        await onSearch()\n    })\n\n    onMounted(async () => {\n        await getOption()\n        await onSearch()\n    })\n\n    return {\n        loading,\n        list,\n        datetimerange,\n        // chartData,\n        // chartSettings,\n        chartOption,\n        onSearch,\n    }\n}\n","<template>\n    <div>\n        <!-- 右上角添加按钮 -->\n        <el-row :gutter=\"20\" justify=\"end\">\n            <el-col\n                :sm=\"24\"\n                :md=\"12\"\n                :lg=\"8\"\n            >\n                <label>天数：</label>\n                <el-input-number\n                    v-model=\"dayNum\"\n                    :min=\"1\"\n                    :max=\"365\"\n                />\n                &nbsp;\n                <el-button type=\"warning\" @click=\"onReCount\">\n                    <el-icon><Refresh /></el-icon>\n                    &nbsp;\n                    重新统计\n                </el-button>\n            </el-col>\n        </el-row>\n        <el-row :gutter=\"20\">\n            <el-col :sm=\"24\">\n                <label>时间范围：</label>\n                <el-date-picker\n                    v-model=\"datetimerange\"\n                    type=\"datetimerange\"\n                    range-separator=\"至\"\n                    start-placeholder=\"开始日期\"\n                    end-placeholder=\"结束日期\"\n                />\n            </el-col>\n            <el-col :sm=\"24\">\n                <VChart class=\"chart\" :option=\"chartOption\" />\n            </el-col>\n            <el-col :sm=\"24\">\n                <CrudList model=\"daily-count\" />\n            </el-col>\n        </el-row>\n    </div>\n</template>\n\n<script lang=\"ts\" setup>\nimport { use } from 'echarts/core'\nimport { CanvasRenderer } from 'echarts/renderers'\nimport { LineChart } from 'echarts/charts'\nimport { TooltipComponent, GridComponent, LegendComponent } from 'echarts/components'\nimport VChart from 'vue-echarts'\nimport { ElMessage, ElMessageBox } from 'element-plus'\nimport { ref } from 'vue'\nimport { useStatistics } from '@/hooks/use-statistics'\nimport { api } from '@/api'\n\nuse([GridComponent, LineChart, CanvasRenderer, TooltipComponent, LegendComponent])\n\nconst {\n    datetimerange,\n    chartOption,\n    onSearch,\n} = useStatistics('daily-count', 'date',\n    ['articleCount', 'resourceCount', 'webhookLogCount', 'feedCount', 'categoryCount', 'hookCount', 'customQueryCount', 'proxyConfigCount', 'userCount'],\n)\n\nconst dayNum = ref(30)\n\nasync function onReCount() {\n    try {\n        await ElMessageBox.confirm(`确定重新统计 ${dayNum.value} 天内的日志吗？此操作可以修复错误的统计数据，但不可回退！`, '提示', {\n            confirmButtonText: '确定',\n            cancelButtonText: '取消',\n            type: 'warning',\n        })\n        await api.api.dailyCountReCount({ dayNum: dayNum.value })\n        ElMessage.success('重新统计成功')\n        await onSearch()\n    } catch (error) {\n        console.error(error)\n        if (error === 'cancel') {\n            return\n        }\n        ElMessage.error('重新统计失败')\n    }\n}\n\n</script>\n\n<style lang=\"scss\" scoped>\n.chart {\n    height: 500px;\n}\n</style>\n"],"names":["useStatistics","model","category","columns","form","ref","loading","list","getOption","page","getList","option","useCrudAjax","defaultDate","dayjs","defaultStart","defaultEnd","datetimerange","column","computed","e","chartOption","get","col","onSearch","start","end","watch","onMounted","use","GridComponent","LineChart","CanvasRenderer","TooltipComponent","LegendComponent","dayNum","onReCount","ElMessageBox","api","ElMessage","error","_createElementBlock","_createVNode","_component_el_row","_component_el_col","_cache","_createElementVNode","_component_el_input_number","$event","_component_el_button","_component_el_icon","_component_Refresh","_component_el_date_picker","_unref","VChart","_component_CrudList"],"mappings":"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"}